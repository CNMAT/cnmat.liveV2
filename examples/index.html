<html>
  <head>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.5.0/socket.io.slim.js"></script>
    <script src="/easyrtc/easyrtc.js"></script>
    <script src="https://unpkg.com/networked-aframe@^0.12.0/dist/networked-aframe.min.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const button = document.getElementById('audioStartButton');
        button.addEventListener('click', function() {
          // Resume the AudioContext to comply with browser autoplay policies
          if (AFRAME.scenes[0].audioListener.context.state === 'suspended') {
            AFRAME.scenes[0].audioListener.context.resume().then(() => {
              console.log('AudioContext resumed!');
              // Change the button color to green to indicate success
              button.style.backgroundColor = 'green';
              button.innerText = 'Audio Started'; // Optionally change button text
              button.disabled = true; // Optionally disable the button after activation
    
              // Play the snap sound
              playSnapSound();
            }).catch(err => {
              console.error('Error resuming AudioContext:', err);
            });
          } else {
            // If AudioContext is already running, just play the sound
            playSnapSound();
          }
        });
    
        function playSnapSound() {
          var soundEl = document.getElementById('snapSound');
          if (soundEl && soundEl.components && soundEl.components.sound) {
            // Stop the currently playing sound
            soundEl.components.sound.stopSound();
            // Immediately play the sound from the beginning
            soundEl.components.sound.playSound();
          }
        }
      });
    </script>
    
    <script>
        AFRAME.registerComponent('spawn-in-circle', {
          schema: {
            radius: {type: 'number', default: 1}
          },
        
          init: function() {
            var el = this.el;
            var center = el.getAttribute('position');
        
            var angleRad = this.getRandomAngleInRadians();
            var circlePoint = this.randomPointOnCircle(this.data.radius, angleRad);
            var worldPoint = {x: circlePoint.x + center.x, y: center.y, z: circlePoint.y + center.z};
            el.setAttribute('position', worldPoint);
        
            var angleDeg = angleRad * 180 / Math.PI;
            var angleToCenter = -1 * angleDeg + 90;
            angleRad = THREE.MathUtils.degToRad(angleToCenter);
            el.object3D.rotation.set(0, angleRad, 0);
          },
        
          getRandomAngleInRadians: function() {
            return Math.random() * Math.PI * 2;
          },
        
          randomPointOnCircle: function (radius, angleRad) {
            var x = Math.cos(angleRad) * radius;
            var y = Math.sin(angleRad) * radius;
            return {x: x, y: y};
          }
        });
        </script>

        <script>

          AFRAME.registerComponent('box1position', {
            schema: {},

            init: function () {
              const wsantiph = 'wss://cnmat.io?channels=aframe';
              const ws = new WebSocket(wsantiph);
                  ws.onopen = () => {
                      console.log('Websocket established');
                  }
                  ws.onmessage = e => {
                    const data = JSON.parse(e.data);
                    if (data.message && data.message.type === 'beep') {
                      const [b] = data.message.data;
                      if (b === 1) {
                        // Ensure the sound entity is fully loaded
                        var soundEl = document.getElementById('snapSound');

                        if (soundEl && soundEl.components.sound) {
                          // If the component is ready, play the sound
                          soundEl.components.sound.playSound();
                          
                        } else if (soundEl) {
                          // If the component is not ready, add an event listener
                          soundEl.addEventListener('loaded', () => {
                            soundEl.components.sound.playSound();
                          });
                        }
                        console.log(b);
                      }
                    }

                    if (data.message && data.message.type === 'beepClient') {
                      console.log("whatever")
                      const b = data.message.data;
                      if (b === 1) {
                        // Ensure the sound entity is fully loaded
                        var soundEl = document.getElementById('snapSound');

                        if (soundEl && soundEl.components.sound) {
                          // If the component is ready, play the sound
                          soundEl.components.sound.playSound();
                          
                        } else if (soundEl) {
                          // If the component is not ready, add an event listener
                          soundEl.addEventListener('loaded', () => {
                            soundEl.components.sound.playSound();
                          });
                        }
                        console.log(b);
                      }
                    }

                    
                    if (data.message && data.message.type === 'heartbeat'){
                      console.log('heartbeat')
                    }
                  };
            },
          });
        </script>

  </head>
  <body>
    <button id="audioStartButton" style="position: absolute; top: 20px; left: 20px; z-index: 1000;">Start Audio</button>
    <a-scene networked-scene="app: myApp; room: room1; debug: true;">

    <a-assets>
        <audio id="snap" src="snap.mp3" preload="auto"></audio>
        <template id="avatar-template">
          <a-entity class="avatar">
            <a-sphere class="head" color="#5985ff" scale="0.45 0.5 0.4" ></a-sphere>
            <a-entity class="face" position="0 0.05 0" >
              <a-sphere class="eye" color="#efefef" position="0.16 0.1 -0.35" scale="0.12 0.12 0.12" >
                <a-sphere class="pupil" color="#000" position="0 0 -1" scale="0.2 0.2 0.2" ></a-sphere>
              </a-sphere>
              <a-sphere class="eye" color="#efefef" position="-0.16 0.1 -0.35" scale="0.12 0.12 0.12" >
                <a-sphere class="pupil" color="#000" position="0 0 -1" scale="0.2 0.2 0.2" ></a-sphere>
              </a-sphere>
            </a-entity>
          </a-entity>
        </template>
      </a-assets>
      
      <a-entity sound="src: #snap"></a-entity>
      <a-entity id="player" networked="template:#avatar-template;attachTemplateToLocal:false;" camera position="0 1.3 0" spawn-in-circle="radius:3;" wasd-controls look-controls></a-entity>
      <a-plane position="0 -1 -4" rotation="-90 0 0" width="40" height="40" color="#f1f1f1" ></a-plane>
      <a-entity position="1 1 -4" geometry="primitive: box; width: 1; height: 1;" sound="src: #snap; autoplay: false" color="#fff000" box1position ></a-entity>
      <a-sound id="snapSound" src="#snap" autoplay="false" loop="false" poolsize="25"></a-sound>
    </a-scene>
  </body>
</html>