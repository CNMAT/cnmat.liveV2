<!DOCTYPE html>
<html>
<head>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.5.0/socket.io.slim.js"></script>
    <script src="/easyrtc/easyrtc.js"></script>
    <script src="https://unpkg.com/networked-aframe@^0.12.0/dist/networked-aframe.min.js"></script>
    <style>
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 10000;
        }
        #splashScreen button {
            margin-top: 20px;
        }
        #spawnAtOriginToggle {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="splashScreen">
        <h1>CNMAT.live</h1>
        <p>Click the button below to start audio and allow positional data to enter the world.</p>
        <button id="startButton">Start</button>
        <label>
          <input type="checkbox" id="spawnAtOriginToggle">
          Spawn at physical location
        </label>
    </div>

<script>
  AFRAME.registerComponent('box1position', {
    init: function () {
      const wsantiph = 'wss://cnmat.io?channels=aframe';
      const ws = new WebSocket(wsantiph);

      ws.onopen = () => {
        console.log('WebSocket established');
      };

      function playSound(soundId) {
        var soundEl = document.getElementById('soundEntity');
        if (soundEl) {
          soundEl.setAttribute('sound', 'src', '#' + soundId); // Set the src attribute dynamically
          soundEl.components.sound.playSound();
        }
      }

      ws.onmessage = e => {
        const data = JSON.parse(e.data);

        if (data.type === 'sendToOne' && data.data === 1) {
          playSound('snap');
        } else if(data.type === 'sendToOne' && data.data === 'stick72'){
          playSound('stick72');
        } else if(data.type === 'sendToOne' && data.data === 'stick73'){
          playSound('stick73');
        } else if(data.type === 'sendToOne' && data.data === 'stick74'){
          playSound('stick74');
        } else if(data.type === 'sendToOne' && data.data === 'stick75'){
          playSound('stick75');
        } else if(data.type === 'sendToOne' && data.data === 'stick76'){
          playSound('stick76');
        } else if(data.type === 'sendToOne' && data.data === 'stick77'){
          playSound('stick77');
        } else if(data.type === 'sendToOne' && data.data === 'stick78'){
          playSound('stick78');
        } else if(data.type === 'sendToOne' && data.data === 'stick79'){
          playSound('stick79');
        } else if(data.type === 'sendToOne' && data.data === 'stick80'){
          playSound('stick80');
        } else if(data.type === 'sendToOne' && data.data === 'stick81'){
          playSound('stick81');
        } else if(data.type === 'sendToOne' && data.data === 'stick82'){
          playSound('stick82');
        } else if(data.type === 'sendToOne' && data.data === 'stick83'){
          playSound('stick83');
        } else if(data.type === 'sendToOne' && data.data === 'stick84'){
          playSound('stick84');
        } else if (data.type.startsWith('stick') && data['0'] === 1) {
          const soundId = data.type; // Use the type directly as the sound ID
          playSound(soundId);
        }

        if (data.type === 'heartbeat') {
          console.log('heartbeat');
        }
      };

      // Clean up WebSocket connection on page unload
      window.addEventListener('beforeunload', () => {
        ws.close();
      });
    }
  });
</script>
    <a-scene networked-scene="app: myApp; room: room1; debug: true;">

    <a-assets>
        <audio id="snap" src="sound/snap.mp3" preload="auto"></audio>
        <audio id="stick72" src="sound/72_stick.mp3" preload="auto"></audio>
        <audio id="stick73" src="sound/73_stick.mp3" preload="auto"></audio>
        <audio id="stick74" src="sound/74_stick.mp3" preload="auto"></audio>
        <audio id="stick75" src="sound/75_stick.mp3" preload="auto"></audio>
        <audio id="stick76" src="sound/76_stick.mp3" preload="auto"></audio>
        <audio id="stick77" src="sound/77_stick.mp3" preload="auto"></audio>
        <audio id="stick78" src="sound/78_stick.mp3" preload="auto"></audio>
        <audio id="stick79" src="sound/79_stick.mp3" preload="auto"></audio>
        <audio id="stick80" src="sound/80_stick.mp3" preload="auto"></audio>
        <audio id="stick81" src="sound/81_stick.mp3" preload="auto"></audio>
        <audio id="stick82" src="sound/82_stick.mp3" preload="auto"></audio>
        <audio id="stick83" src="sound/83_stick.mp3" preload="auto"></audio>
        <audio id="stick84" src="sound/84_stick.mp3" preload="auto"></audio>
        
        <template id="avatar-template">
          <a-entity class="avatar">
            <a-sphere class="head" color="#5985ff" scale="0.45 0.5 0.4" ></a-sphere>
            <a-entity class="face" position="0 0.05 0" >
              <a-sphere class="eye" color="#efefef" position="0.16 0.1 -0.35" scale="0.12 0.12 0.12" >
                <a-sphere class="pupil" color="#000" position="0 0 -1" scale="0.2 0.2 0.2" ></a-sphere>
              </a-sphere>
              <a-sphere class="eye" color="#efefef" position="-0.16 0.1 -0.35" scale="0.12 0.12 0.12" >
                <a-sphere class="pupil" color="#000" position="0 0 -1" scale="0.2 0.2 0.2" ></a-sphere>
              </a-sphere>
            </a-entity>
          </a-entity>
        </template>
      </a-assets>
      
      <a-entity id="player" networked="template:#avatar-template;attachTemplateToLocal:false;" sound="src: #snap; autoplay: false" camera position="0 1.3 0" wasd-controls look-controls></a-entity>
      <a-plane position="0 -1 -4" rotation="-90 0 0" width="40" height="40" color="#f1f1f1" ></a-plane>
      <a-box position="0 2 -12" width="2" height="2" color="#ff0000" ></a-plane>
      <a-box position="0 3 32" width="2" height="1" depth="2" color="#0000ff" ></a-plane>
      <a-box position="42 2 32" width="3" height="1" depth="2" color="#00ffff" ></a-plane>
     
      <a-entity id="soundEntity" position="1 1 -4" sound="autoplay: false" box1position></a-entity>


    </a-scene>
    <script>

        var spawnPoint = null;
        var firstUpdateProcessed = false;
        var geoWatchId = null;

    // Function to update the avatar's position
    function updateAvatarPosition(position) {
        if (!firstUpdateProcessed && spawnPoint && spawnPoint.latitude === 0 && spawnPoint.longitude === 0) {
            firstUpdateProcessed = true;
            return;
        }

        var latitude = position.coords.latitude;
        var longitude = position.coords.longitude;

        if (spawnPoint === null) {
            spawnPoint = {latitude: latitude, longitude: longitude};
        }

        var latitudeOffset = latitude - spawnPoint.latitude;
        var longitudeOffset = longitude - spawnPoint.longitude;

        var avatar = document.getElementById('player');
        avatar.setAttribute('position', `${latitudeOffset} 0 ${longitudeOffset}`);
    }

    document.addEventListener('DOMContentLoaded', () => {
        const button = document.getElementById('startButton');
        button.addEventListener('click', function() {
          // Resume the AudioContext to comply with browser autoplay policies
          if (AFRAME.scenes[0].audioListener.context.state === 'suspended') {
            AFRAME.scenes[0].audioListener.context.resume().then(() => {
              console.log('AudioContext resumed!');
              // // Change the button color to green to indicate success
              // button.style.backgroundColor = 'green';
              // button.innerText = 'Audio Started'; // Optionally change button text
              // button.disabled = true; // Optionally disable the button after activation
    
              // Play the snap sound
              playSnapSound();
            }).catch(err => {
              console.error('Error resuming AudioContext:', err);
            });
          } else {
            // If AudioContext is already running, just play the sound
            playSnapSound();
          }
        });
    
        function playSnapSound() {
          var soundEl = document.getElementById('snapSound');
          if (soundEl && soundEl.components && soundEl.components.sound) {
            // Stop the currently playing sound
            soundEl.components.sound.stopSound();
            // Immediately play the sound from the beginning
            soundEl.components.sound.playSound();
          }
        }
      });

    document.getElementById('startButton').addEventListener('click', function() {
        var spawnAtOrigin = document.getElementById('spawnAtOriginToggle').checked;
        if (spawnAtOrigin) {
            spawnPoint = {latitude: 0, longitude: 0};
        } else {
            spawnPoint = null;
            firstUpdateProcessed = false;
        }

        // Hide the splash screen
        document.getElementById('splashScreen').style.display = 'none';

        // Start the audio
        var audioContext = AFRAME.scenes[0].audioListener.context;
        if (audioContext.state === 'suspended') {
            audioContext.resume().then(() => {
                console.log('AudioContext resumed!');
            }).catch(err => {
                console.error('Error resuming AudioContext:', err);
            });
        }

        if ('geolocation' in navigator) {
            geoWatchId = navigator.geolocation.watchPosition(updateAvatarPosition, function(error) {
                console.error('Error watching location:', error);
            }, {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 5000
            });
        } else {
            console.log('Geolocation is not supported by this browser.');
        }
      });

    document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                document.getElementById('splashScreen').style.display = 'flex';
                if (geoWatchId !== null) {
                    navigator.geolocation.clearWatch(geoWatchId);
                    geoWatchId = null;
                }
            }
        });

  </script>

  </body>
</html>