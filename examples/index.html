<html>
  <head>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.5.0/socket.io.slim.js"></script>
    <script src="/easyrtc/easyrtc.js"></script>
    <script src="https://unpkg.com/networked-aframe@^0.12.0/dist/networked-aframe.min.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const button = document.getElementById('audioStartButton');
        button.addEventListener('click', function() {
          // Resume the AudioContext to comply with browser autoplay policies
          if (AFRAME.scenes[0].audioListener.context.state === 'suspended') {
            AFRAME.scenes[0].audioListener.context.resume().then(() => {
              console.log('AudioContext resumed!');
              // Change the button color to green to indicate success
              button.style.backgroundColor = 'green';
              button.innerText = 'Audio Started'; // Optionally change button text
              button.disabled = true; // Optionally disable the button after activation
    
              // Play the snap sound
              playSnapSound();
            }).catch(err => {
              console.error('Error resuming AudioContext:', err);
            });
          } else {
            // If AudioContext is already running, just play the sound
            playSnapSound();
          }
        });
    
        function playSnapSound() {
          var soundEl = document.getElementById('snapSound');
          if (soundEl && soundEl.components && soundEl.components.sound) {
            // Stop the currently playing sound
            soundEl.components.sound.stopSound();
            // Immediately play the sound from the beginning
            soundEl.components.sound.playSound();
          }
        }
      });
    </script>
    
    <script>
        AFRAME.registerComponent('spawn-in-circle', {
          schema: {
            radius: {type: 'number', default: 1}
          },
        
          init: function() {
            var el = this.el;
            var center = el.getAttribute('position');
        
            var angleRad = this.getRandomAngleInRadians();
            var circlePoint = this.randomPointOnCircle(this.data.radius, angleRad);
            var worldPoint = {x: circlePoint.x + center.x, y: center.y, z: circlePoint.y + center.z};
            el.setAttribute('position', worldPoint);
        
            var angleDeg = angleRad * 180 / Math.PI;
            var angleToCenter = -1 * angleDeg + 90;
            angleRad = THREE.MathUtils.degToRad(angleToCenter);
            el.object3D.rotation.set(0, angleRad, 0);
          },
        
          getRandomAngleInRadians: function() {
            return Math.random() * Math.PI * 2;
          },
        
          randomPointOnCircle: function (radius, angleRad) {
            var x = Math.cos(angleRad) * radius;
            var y = Math.sin(angleRad) * radius;
            return {x: x, y: y};
          }
        });
        </script>

<script>
  AFRAME.registerComponent('box1position', {
    init: function () {
      const wsantiph = 'wss://cnmat.io?channels=aframe';
      const ws = new WebSocket(wsantiph);

      ws.onopen = () => {
        console.log('WebSocket established');
      };

      function playSound(soundId) {
        var soundEl = document.getElementById('soundEntity');
        if (soundEl) {
          soundEl.setAttribute('sound', 'src', '#' + soundId); // Set the src attribute dynamically
          soundEl.components.sound.playSound();
        }
      }

      ws.onmessage = e => {
        const data = JSON.parse(e.data);

        if (data.type === 'sendToOne' && data.data === 1) {
          playSound('snap');
        } else if(data.type === 'sendToOne' && data.data === 'stick72'){
          playSound('stick72');
        } else if(data.type === 'sendToOne' && data.data === 'stick73'){
          playSound('stick73');
        } else if(data.type === 'sendToOne' && data.data === 'stick74'){
          playSound('stick74');
        } else if(data.type === 'sendToOne' && data.data === 'stick75'){
          playSound('stick75');
        } else if(data.type === 'sendToOne' && data.data === 'stick76'){
          playSound('stick76');
        } else if(data.type === 'sendToOne' && data.data === 'stick77'){
          playSound('stick77');
        } else if(data.type === 'sendToOne' && data.data === 'stick78'){
          playSound('stick78');
        } else if(data.type === 'sendToOne' && data.data === 'stick79'){
          playSound('stick79');
        } else if(data.type === 'sendToOne' && data.data === 'stick80'){
          playSound('stick80');
        } else if(data.type === 'sendToOne' && data.data === 'stick81'){
          playSound('stick81');
        } else if(data.type === 'sendToOne' && data.data === 'stick82'){
          playSound('stick82');
        } else if(data.type === 'sendToOne' && data.data === 'stick83'){
          playSound('stick83');
        } else if(data.type === 'sendToOne' && data.data === 'stick84'){
          playSound('stick84');
        } else if (data.type.startsWith('stick') && data['0'] === 1) {
          const soundId = data.type; // Use the type directly as the sound ID
          playSound(soundId);
        }

        if (data.type === 'heartbeat') {
          console.log('heartbeat');
        }
      };

      // Clean up WebSocket connection on page unload
      window.addEventListener('beforeunload', () => {
        ws.close();
      });
    }
  });
</script>
  

  </head>
  <body>
    <button id="audioStartButton" style="position: absolute; top: 20px; left: 20px; z-index: 1000;">Start Audio</button>
    <a-scene networked-scene="app: myApp; room: room1; debug: true;">

    <a-assets>
        <audio id="snap" src="sound/snap.mp3" preload="auto"></audio>
        <audio id="stick72" src="sound/72_stick.mp3" preload="auto"></audio>
        <audio id="stick73" src="sound/73_stick.mp3" preload="auto"></audio>
        <audio id="stick74" src="sound/74_stick.mp3" preload="auto"></audio>
        <audio id="stick75" src="sound/75_stick.mp3" preload="auto"></audio>
        <audio id="stick76" src="sound/76_stick.mp3" preload="auto"></audio>
        <audio id="stick77" src="sound/77_stick.mp3" preload="auto"></audio>
        <audio id="stick78" src="sound/78_stick.mp3" preload="auto"></audio>
        <audio id="stick79" src="sound/79_stick.mp3" preload="auto"></audio>
        <audio id="stick80" src="sound/80_stick.mp3" preload="auto"></audio>
        <audio id="stick81" src="sound/81_stick.mp3" preload="auto"></audio>
        <audio id="stick82" src="sound/82_stick.mp3" preload="auto"></audio>
        <audio id="stick83" src="sound/83_stick.mp3" preload="auto"></audio>
        <audio id="stick84" src="sound/84_stick.mp3" preload="auto"></audio>
        
        <template id="avatar-template">
          <a-entity class="avatar">
            <a-sphere class="head" color="#5985ff" scale="0.45 0.5 0.4" ></a-sphere>
            <a-entity class="face" position="0 0.05 0" >
              <a-sphere class="eye" color="#efefef" position="0.16 0.1 -0.35" scale="0.12 0.12 0.12" >
                <a-sphere class="pupil" color="#000" position="0 0 -1" scale="0.2 0.2 0.2" ></a-sphere>
              </a-sphere>
              <a-sphere class="eye" color="#efefef" position="-0.16 0.1 -0.35" scale="0.12 0.12 0.12" >
                <a-sphere class="pupil" color="#000" position="0 0 -1" scale="0.2 0.2 0.2" ></a-sphere>
              </a-sphere>
            </a-entity>
          </a-entity>
        </template>
      </a-assets>
      
      <a-entity id="player" networked="template:#avatar-template;attachTemplateToLocal:false;" sound="src: #snap; autoplay: false" camera position="0 1.3 0" spawn-in-circle="radius:3;" wasd-controls look-controls></a-entity>
      <a-plane position="0 -1 -4" rotation="-90 0 0" width="40" height="40" color="#f1f1f1" ></a-plane>
     
      <a-entity id="soundEntity" position="1 1 -4" sound="autoplay: false" box1position></a-entity>


    </a-scene>
  </body>
</html>