<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.5.0/socket.io.slim.js"></script>
    <script src="/easyrtc/easyrtc.js"></script>
    <script src="https://unpkg.com/networked-aframe@^0.12.0/dist/networked-aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-extras/dist/aframe-extras.min.js"></script>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            min-height: 100vh; /* Full height of the viewport */
            margin: 0; /* Remove default margin */
        }
        #splashScreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 10000;
    text-align: center; /* Ensures text elements are centered if not otherwise specified */
}

#splashScreen label {
    display: flex;
    flex-direction: row; /* Layout the checkbox and paragraph in a row */
    align-items: center;
    justify-content: center; /* Center the label content horizontally in the splashScreen */
    width: 100%; /* Ensures the label takes full width to utilize justify-content properly */
}

#splashScreen label p {
    margin-left: 10px; /* Space between checkbox and paragraph */
    width: 50%; /* Adjust width if necessary */
    text-align: left; /* Text inside the paragraph aligned left */
}
    </style>
</head>
<body>
    <div id="splashScreen">
        <h1>CNMAT.live</h1>
        <p>Click the button below to start audio and allow positional data to enter the world.</p>
        <button id="startButton">Start</button>
        <br>
        <br>
        <label>
          <input type="checkbox" id="spawnAtOriginToggle">
          <p>Select this box to allow CNMAT.live to use your information from cellular, Wi-Fi, Global Positioning System (GPS), networks, and Bluetooth to determine your current location.</p>
        </label>
    </div>

<script>
  AFRAME.registerComponent('box1position', {
    init: function () {
      const wsantiph = 'wss://cnmat.io?channels=aframe';
      const ws = new WebSocket(wsantiph);

      ws.onopen = () => {
        console.log('WebSocket established');
      };

      function playSound(soundId) {
        var soundEl = document.getElementById('soundEntity');
        if (soundEl) {
          soundEl.setAttribute('sound', 'src', '#' + soundId); // Set the src attribute dynamically
          soundEl.components.sound.playSound();
        }
      }

      ws.onmessage = e => {
        const data = JSON.parse(e.data);

        if (data.type === 'sendToOne' && data.data === 1) {
          playSound('snap');
        } else if(data.type === 'sendToOne' && data.data === 'stick72'){
          playSound('stick72');
        } else if(data.type === 'sendToOne' && data.data === 'stick73'){
          playSound('stick73');
        } else if(data.type === 'sendToOne' && data.data === 'stick74'){
          playSound('stick74');
        } else if(data.type === 'sendToOne' && data.data === 'stick75'){
          playSound('stick75');
        } else if(data.type === 'sendToOne' && data.data === 'stick76'){
          playSound('stick76');
        } else if(data.type === 'sendToOne' && data.data === 'stick77'){
          playSound('stick77');
        } else if(data.type === 'sendToOne' && data.data === 'stick78'){
          playSound('stick78');
        } else if(data.type === 'sendToOne' && data.data === 'stick79'){
          playSound('stick79');
        } else if(data.type === 'sendToOne' && data.data === 'stick80'){
          playSound('stick80');
        } else if(data.type === 'sendToOne' && data.data === 'stick81'){
          playSound('stick81');
        } else if(data.type === 'sendToOne' && data.data === 'stick82'){
          playSound('stick82');
        } else if(data.type === 'sendToOne' && data.data === 'stick83'){
          playSound('stick83');
        } else if(data.type === 'sendToOne' && data.data === 'stick84'){
          playSound('stick84');
        } else if (data.type.startsWith('stick') && data['0'] === 1) {
          const soundId = data.type; // Use the type directly as the sound ID
          playSound(soundId);
        } else if (data.type.startsWith('sine') && data['0'] === 1) {
          const soundId = data.type; // Use the type directly as the sound ID
          playSound(soundId);
        } else if (data.type.startsWith('ed') && data['0'] === 1) {
          const soundId = data.type; // Use the type directly as the sound ID
          playSound(soundId);
        }

        if (data.type === 'heartbeat') {
          console.log('heartbeat');
        }
      };

      // Clean up WebSocket connection on page unload
      window.addEventListener('beforeunload', () => {
        ws.close();
      });
    }
  });
</script>
    <a-scene networked-scene="app: myApp; room: room1; debug: true;">

    <a-assets timeout="10000">
        <audio id="snap" src="sound/snap.mp3" preload="auto"></audio>
        <audio id="sine60" src="sound/60_longSine.mp3" preload="auto"></audio>
        <audio id="sine61" src="sound/61_longSine.mp3" preload="auto"></audio>
        <audio id="sine62" src="sound/62_longSine.mp3" preload="auto"></audio>
        <audio id="sine63" src="sound/63_longSine.mp3" preload="auto"></audio>
        <audio id="sine64" src="sound/63_longSine.mp3" preload="auto"></audio>
        <audio id="sine65" src="sound/64_longSine.mp3" preload="auto"></audio>
        <audio id="sine66" src="sound/65_longSine.mp3" preload="auto"></audio>
        <audio id="sine67" src="sound/66_longSine.mp3" preload="auto"></audio>
        <audio id="sine68" src="sound/67_longSine.mp3" preload="auto"></audio>
        <audio id="sine69" src="sound/68_longSine.mp3" preload="auto"></audio>
        <audio id="sine70" src="sound/69_longSine.mp3" preload="auto"></audio>
        <audio id="stick72" src="sound/72_stick.mp3" preload="auto"></audio>
        <audio id="stick73" src="sound/73_stick.mp3" preload="auto"></audio>
        <audio id="stick74" src="sound/74_stick.mp3" preload="auto"></audio>
        <audio id="stick75" src="sound/75_stick.mp3" preload="auto"></audio>
        <audio id="stick76" src="sound/76_stick.mp3" preload="auto"></audio>
        <audio id="stick77" src="sound/77_stick.mp3" preload="auto"></audio>
        <audio id="stick78" src="sound/78_stick.mp3" preload="auto"></audio>
        <audio id="stick79" src="sound/79_stick.mp3" preload="auto"></audio>
        <audio id="stick80" src="sound/80_stick.mp3" preload="auto"></audio>
        <audio id="stick81" src="sound/81_stick.mp3" preload="auto"></audio>
        <audio id="stick82" src="sound/82_stick.mp3" preload="auto"></audio>
        <audio id="stick83" src="sound/83_stick.mp3" preload="auto"></audio>
        <audio id="stick84" src="sound/84_stick.mp3" preload="auto"></audio>
        <audio id="ed_00_gtr_a3" src="sound/00_gtr_a3.mp3" preload="auto"></audio>
        <audio id="ed_01_gtr_as2" src="sound/01_gtr_as2.mp3" preload="auto"></audio>
        <audio id="ed_02_gtr_b4" src="sound/02_gtr_b4.mp3" preload="auto"></audio>
        <audio id="ed_03_gtr_b5" src="sound/03_gtr_b5.mp3" preload="auto"></audio>
        <audio id="ed_04_gtr_c4" src="sound/04_gtr_c4.mp3" preload="auto"></audio>
        <audio id="ed_05_gtr_ds3" src="sound/05_gtr_ds3.mp3" preload="auto"></audio>
        <audio id="ed_06_gtr_d4" src="sound/06_gtr_d4.mp3" preload="auto"></audio>
        <audio id="ed_07_gtr_d5" src="sound/07_gtr_d5.mp3" preload="auto"></audio>
        <audio id="ed_08_gtr_e3" src="sound/08_gtr_e3.mp3" preload="auto"></audio>
        <audio id="ed_09_gtr_e5" src="sound/09_gtr_e5.mp3" preload="auto"></audio>
        <audio id="ed_10_gtr_fs5" src="sound/10_gtr_fs5.mp3" preload="auto"></audio>
        <audio id="ed_11_gtr_f2" src="sound/11_gtr_f2.mp3" preload="auto"></audio>
        <audio id="ed_12_gtr_f4" src="sound/12_gtr_f4.mp3" preload="auto"></audio>
        <audio id="ed_13_gtr_gs4" src="sound/13_gtr_gs4.mp3" preload="auto"></audio>
        <audio id="ed_14_gtr_g4" src="sound/14_gtr_g4.mp3" preload="auto"></audio>
        
        <template id="avatar-template">
          <a-entity class="avatar">
            <a-box class="head" color="#5985ff" scale="0.45 0.5 0.4" ></a-box>
            <a-entity class="face" position="0 0.05 0" >
              <a-sphere class="eye" color="#efefef" position="0.16 0.1 -0.35" scale="0.12 0.12 0.12" >
                <a-sphere class="pupil" color="#000" position="0 0 -1" scale="0.2 0.2 0.2" ></a-sphere>
              </a-sphere>
              <a-sphere class="eye" color="#efefef" position="-0.16 0.1 -0.35" scale="0.12 0.12 0.12" >
                <a-sphere class="pupil" color="#000" position="0 0 -1" scale="0.2 0.2 0.2" ></a-sphere>
              </a-sphere>
            </a-entity>
          </a-entity>
        </template>
      </a-assets>
      
      <a-entity id="player" networked="template:#avatar-template;attachTemplateToLocal:false;" sound="src: #snap; autoplay: false" camera position="0 1.3 0" camera look-controls universal-controls></a-entity>
      <a-plane position="0 -1 -10" rotation="-90 0 0" width="300" height="300" color="#f1f1f1" ></a-plane>
      <a-box position="0 2 -12" width="2" height="2" color="#ff0000" ></a-plane>
      <a-box position="0 3 32" width="2" height="1" depth="2" color="#0000ff" ></a-plane>
      <a-box position="42 2 32" width="3" height="1" depth="2" color="#00ffff" ></a-plane>
     
      <a-entity id="soundEntity" position="1 1 -4" sound="autoplay: false" box1position></a-entity>


    </a-scene>
    <script>
      var spawnPoint = null;
      var firstUpdateProcessed = false;
      var geoWatchId = null;
      var lastUpdate = Date.now();
      var updateThreshold = 100;
      
      document.addEventListener('DOMContentLoaded', () => {
          const startButton = document.getElementById('startButton');
  
          function generateNoise() {
              // Generates a small random noise between -5 and 5 meters
              return (Math.random() - 0.5) * 10 / 111000; // Convert meters to degrees
          }
  
          function initializeGeolocation() {
              if (geoWatchId !== null) {
                  navigator.geolocation.clearWatch(geoWatchId);
              }
  
              geoWatchId = navigator.geolocation.watchPosition(updateAvatarPosition, showError, {
                  enableHighAccuracy: true,
                  maximumAge: 0,
                  timeout: 5000
              });
          }
  
          function updateAvatarPosition(position) {
              var latitude = position.coords.latitude;
              var longitude = position.coords.longitude;
  
              if (spawnPoint === null) {
                  // Applying noise to the initial position
                  spawnPoint = {
                      latitude: latitude + generateNoise(),
                      longitude: longitude + generateNoise()
                  };
              }
  
              var latitudeOffset = (latitude - spawnPoint.latitude) * 111000; // 1 degree latitude = 111 km
              var longitudeOffset = (longitude - spawnPoint.longitude) * (Math.cos(latitude * Math.PI / 180) * 111000);
  
              var avatar = document.getElementById('player');
              avatar.setAttribute('position', `${longitudeOffset} 0 ${latitudeOffset}`);
              console.log('Updated position:', longitudeOffset, latitudeOffset);
          }
  
          function showError(error) {
              console.error('Error watching location:', error);
          }
  
          startButton.addEventListener('click', () => {
              var spawnAtOrigin = document.getElementById('spawnAtOriginToggle').checked;
              spawnPoint = spawnAtOrigin ? {latitude: 0 + generateNoise(), longitude: 0 + generateNoise()} : null;
              firstUpdateProcessed = false;
  
              document.getElementById('splashScreen').style.display = 'none';
              var audioContext = AFRAME.scenes[0].audioListener.context;
              if (audioContext.state === 'suspended') {
                  audioContext.resume().then(() => {
                      console.log('AudioContext resumed!');
                  }).catch(err => {
                      console.error('Error resuming AudioContext:', err);
                  });
              }
  
              initializeGeolocation();
          });
  
          document.addEventListener('keydown', function(event) {
              if (event.key === 'Escape') {
                  document.getElementById('splashScreen').style.display = 'flex';
                  if (geoWatchId !== null) {
                      navigator.geolocation.clearWatch(geoWatchId);
                      geoWatchId = null;
                  }
              }
          });
      });
      ///////////// CNMAT Location -10712328.176228292 4204317.812115532  -- 37.876690,-122.264417
      ///////////// -10712322.981879065 4204321.712892281
  </script>
  </body>
</html>